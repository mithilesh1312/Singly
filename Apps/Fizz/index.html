
<!DOCTYPE html>
<html>
    <head>
        <link rel="icon" href="/favicon.gif" /> 
        <title>Fizz &#8212; Social Network Visualization &#8212; by Bloom</title>
        <link rel="stylesheet" href="style.css" type="text/css" media="screen" />
        <link rel="stylesheet" href="fonts/fonts.css" type="text/css" media="screen" />
        <script type="text/javascript">
            var _gaq = _gaq || [];
            _gaq.push(['_setAccount', 'UA-20672308-1']);
            _gaq.push(['_trackPageview']);
            (function() {
                if (window.location.host !== 'bloom.io') return;
                var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
                ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
                var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
            })();
        </script>
    </head>
    <body>
        <div id="widget">
            <canvas width="640" height="385" id="fizz"></canvas>
            <div id="about">
                <h1 class="bloombrand"><a href="./">Fizz</a></h1><h2> &#8212; a <a href="http://bloom.io" target="_blank" title="Bloom: pop-cultural instruments for data expression and exploration.">bloom</a> thing</h2>
                <div id="authbits">
                    <p>Big circles are people, small circles are their status updates. Connect with Twitter or Facebook and see what&#8217;s happening!</p>
                    <button class="awesome" id="loginfb" title="Connect with Facebook">Facebook</button>
                    <button class="awesome" id="logintw" title="Connect with Twitter">Twitter</button>
                    <button class="awesome" id="logingm" title="Connect with Gmail">Gmail</button>
                </div>
            </div>
            <div id="userinfo"></div>
            <div id="hovercard"><div class="inner"></div></div>            
            <form id="search">
                <input type="search" placeholder="Type to search visible posts..." size="32" /><button type="submit" class="awesome">Search</button>
            </form>
            <div id="bug"><a href="http://bloom.io" target="_blank" title="Bloom: pop-cultural instruments for data expression and exploration."><img src="images/bloom-logo-small.png" alt="bloom" border="0"></a></div>
            <div id="footer">&copy Copyright 2011 <a href="http://bloom.io" target="_blank" title="Bloom: pop-cultural instruments for data expression and exploration.">Bloom</a>. All Rights Reserved.</div>
        </div>
        <div id="fb-root"></div>
    </body>        
    <script src="lib/anywhere.js"></script>
    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/processing-1.0.0.min.js"></script>
    <script type="text/javascript" src="fizz.js"></script>
    <script src="lib/all.js"></script>
    <script type="text/javascript" src="utils.js"></script>
    <script type="text/javascript" src="twitter-text.js"></script>
    <script type="text/javascript">

$(document).ready(function() {

    $('#about').css({ 
        top: -125 + window.innerHeight/2,
        left: -220 + window.innerWidth/2,
    }).fadeIn('fast');
    
    $(window).resize(function() {
        if (!Fizz.active()) {
            $('#about').css({ 
                top: -125 + window.innerHeight/2,
                left: -220 + window.innerWidth/2,
            });
        }
    });


    Fizz.init('fizz');

    function getPermalink(status) {
        //console.log(status);
        if (status.from && status.id) { //facebook
            return 'http://facebook.com/'+status.id.split('_').join('/posts/');
        } else if(status.from && status['message-id']) {
            return '';
        }
        return 'http://twitter.com/'+status.user.screenName+'/status/'+status.idStr;
    }
    
    function getLinkedStatus(status) {
        return twttr.txt.autoLink(status.text);
    }

    $('#fizz').bind('bubbleClick', function(event, userId, id, mouseX, mouseY) {
        if (!userId) {
            $('#hovercard').hide();
            return;
        }
        var user = usersById[userId],
            status = id ? statusesById[id] : null,
            html = '<span class="user">'+user.text+'<\/span>';
        if (status) {
          html += ' ' + '<span class="date"><a href="'+getPermalink(status.data)+'">' + formatDate(status.time) + "<\/a><\/span><br>" + getLinkedStatus(status);
        }
        $('#hovercard div.inner').html(html);
        var card = $('#hovercard').show(), 
            s = card[0].style,
            left = Math.max(0,Math.min(window.innerWidth-card[0].offsetWidth,(mouseX-(card[0].offsetWidth/2)))),
            top = (mouseY-20-card[0].offsetHeight);
        if (top < 0) {
            top = mouseY + 20;
        }
        s.left = left+'px';
        s.top = top+'px';
    });
    
    var events = [ 'blur', 'mouseup', 'input', 'keyup', 'search' ];
    function onInput() { Fizz.highlight($(this).attr('value')); }
    $(events).each(function(i, event) {
        $('#search input').bind(event, onInput);
    });

    $('#search').bind('submit', function() { 
        return false;
    });
    $('#logintw').bind('click', function() {
        initTwitter();
    });
    $('#logingm').bind('click', function() {
        initGmail();
    });
    
});

var usersById = {}; // normalized
var statusesById = {}; // normalized
/*
// initialize the library with the API key
if (window.location.hostname == "bloom.io") {
    // http://bloom.io/facebook/
    FB.init({ appId: '135870143131638', apiKey: 'ce0762a3a18f04e3dc2c0e918ab24081' });
}
else {
    // http://tom.local/~tom/bloom/
    FB.init({ appId: '162892603738802', apiKey: 'b484273dbb4508117f0d9cfbf79894bf' });
}*/

$('#loginfb').bind('click', function() {
//    FB.login(handleFBSessionResponse, {perms:'read_stream'});    
    startFB();
});

function startFB() {
    $('#about').fadeOut('fast');
    $('#search').fadeIn('fast');
    //$('#userinfo').html('<img src="'+response[0].pic+'" alt="'+response[0].name+'" class="user"/> <b>This is Fizz.</b> <a href="https://spreadsheets.google.com/viewform?hl=en&formkey=dGZINGpDQ3NubVNiMlY3eFZ6MUNGdFE6MQ#gid=0">We&#8217;d love to know what you think<\/a>. <br><br>You&#8217;re logged in as ' + response[0].name + ' on Facebook.').fadeIn('fast');
    //$('#userinfo').html('<b>This is Fizz.</b> <a href="https://spreadsheets.google.com/viewform?hl=en&formkey=dGZINGpDQ3NubVNiMlY3eFZ6MUNGdFE6MQ#gid=0">We&#8217;d love to know what you think<\/a>. <br><br>').fadeIn('fast');
    $('#userinfo').html('<b>This is Fizz, from Bloom</b> You\'re looking at Facebook statuses in Simon Murtha-Smith\'s news feed pulled from his Locker. Big circles are people, small circles are status updates.').fadeIn('fast');
    initForFBUser();
}
/*
// handle a session response from any of the auth related calls
function handleFBSessionResponse(response) {

    // if we dont have a session, just hide the user info
    if (!response.session) {
        // TODO: log this error, deal
        alert('error with Facebook authentication, sorry!');    
        $('#userinfo').fadeOut('fast');
        $('#about').fadeIn('fast');
        $('#search').fadeOut('fast');        
        if (Fizz.active()) {
            Fizz.active(false);
        }
        return;
    }
    
    $('#about').fadeOut('fast');
    $('#search').fadeIn('fast');

    // if we have a session, query for the user's profile picture and name
    FB.api(
        { 
            method: 'fql.query', 
            query: 'SELECT name, pic FROM profile WHERE id=me()'
        },
        function(response) { 
            $('#userinfo').html('<img src="'+response[0].pic+'" alt="'+response[0].name+'" class="user"/> <b>This is Fizz.</b> <a href="https://spreadsheets.google.com/viewform?hl=en&formkey=dGZINGpDQ3NubVNiMlY3eFZ6MUNGdFE6MQ#gid=0">We&#8217;d love to know what you think<\/a>. <br><br>You&#8217;re logged in as ' + response[0].name + ' on Facebook.').fadeIn('fast');
        }
    );
    
    initForFBUser();
}
*/
function initForFBUser() {

    Fizz.active(true);

    // and home (news feed)
    var pages = 0;
    var maxPages = 10;
    var perPage = 100;
    $('#timeline').addClass("loading");
    $('#loadinfo').html("Loading page " + (pages+1) + " of " + maxPages);
    console.log('getting /getfeed...');
    $.getJSON('/getfeed', function(response) {
    console.log('got fb feed.');
        parseResponse(response);
    });
    //FB.api('/me/home', parseResponse, { limit: perPage, offset: 0 });
    
    function parseResponse(response) {
        if (!Fizz.active()) return;
        if (response.data && response.data.length) {
            renderStuff(response.data);
        }
       // pages++;
    //    $('#loadinfo').html("Loading page " + (pages+1) + " of " + maxPages);
        //if (pages < maxPages && response.data && response.data.length) {
        //    // TODO: investigate response.paging.previous / response.paging.next again sometime
        //    FB.api('/me/home', parseResponse, { limit: perPage, until: response.data[response.data.length-1].updated_time });
       // }
       // else {
            // TODO: loadinfo for fizz
            $('#timeline').removeClass("loading");
            $('#loadinfo').hide('fast');
        //}
    }

    function renderStuff(data) {
        if (!Fizz.active()) return;
        var entry = data.pop();
        if (!(entry.from.id in usersById)) {
            usersById[entry.from.id] = { id: entry.from.id, text: entry.from.name, size: 6 + Math.random() * 4, data: entry.from };
            Fizz.addBubble(usersById[entry.from.id]);
        }
        if (!(entry.id in statusesById)) {
            //console.log(entry);
            var t = parseFBDate(entry.created_time);
            statusesById[entry.id] = { id: entry.id, time: t, text: entry.message || entry.description || entry.caption || '', size: 6 + Math.random() * 4, data: entry };
            Fizz.addBubble(statusesById[entry.id], entry.from.id);
            if (data.length) {
                setTimeout(renderStuff, 30, data);
            }
        }
    }
    
}

//var twUser = null;

//twttr.anywhere(function(T) {
//    window.T = T;
//    T.bind("authComplete", onTwAuthComplete); // triggered when auth completed successfully
//    $('#logintw').bind('click', function() {
//        T.signIn();
   // });
//});

function onTwAuthComplete(status, user) {
    if (!status) {
        // TODO: log this error, deal
        alert('error with Twitter authentication, sorry!');
        $('#userinfo').fadeOut('fast');
        $('#about').fadeIn('fast');
        $('#search').fadeOut('fast');        
        if (Fizz.active()) {
            Fizz.active(false);
        }
        return;
    }

    $('#about').fadeOut('fast');
    $('#search').fadeIn('fast');

    twUser = user;
    initForTwUser(twUser);
}

function initGmail() {
    $('#about').fadeOut('fast');
    $('#search').fadeIn('fast');
    
    if (!Fizz.active()) {
        Fizz.active(true);
        $('#userinfo').html('<b>This is Fizz, from Bloom</b> You\'re looking at messages in Simon Murtha-Smith\'s inbox pulled from his Locker. Big circles are people, small circles are messages.').fadeIn('fast');
        console.log('getting gmail /get_gmail...');
        $.getJSON('/get_gmail', function(response) {
            console.log('got gmail.');
//            console.log(response);
            onGmailLoaded(response);
        });
    }
    
    var numTweets = 0;
    var numPages = 0;
    var maxNumPages = 5; // n * 100 tweets will be shown
    
    function onGmailLoaded(rsp) {
        if (!Fizz.active()) return;
        numPages++;
        var messages = rsp;
        if (messages && messages.length) {
            var maxId = numPages < maxNumPages && messages.length ? messages[messages.length-1]["message-id"] : null;
            addMessageFromMessages(messages.slice(), maxId);
        }
    }
    

    function addMessageFromMessages(messages, maxId) {
        if (!Fizz.active()) return;
        var mess = messages.pop();
        if (!(mess.from in usersById)) {
            usersById[mess.from] = { id: mess.from, text: mess.from, size: 6 + Math.random() * 4, data: mess.from };
            Fizz.addBubble(usersById[mess.from]);
        }
        if (!(mess["message-id"] in statusesById)) {
            statusesById[mess["message-id"]] = { id: mess["message-id"], text: mess.subject, time: Date.parse(mess.date), size: 6 + Math.random() * 4, data: mess };
            Fizz.addBubble(statusesById[mess["message-id"]], mess.from);
        }
        if (messages.length) {
            setTimeout(addMessageFromMessages, 30, messages, maxId);
        }
        else if (maxId) {
         //   window.fetchTweets(maxId);
        }
    }
}

    
function initTwitter() {
    $('#about').fadeOut('fast');
    $('#search').fadeIn('fast');
    
    if (!Fizz.active()) {
        Fizz.active(true);
        $('#userinfo').html('<b>This is Fizz, from Bloom</b> You\'re looking at tweets in Simon Murtha-Smith\'s timeline pulled from his Locker. Big circles are people, small circles are status updates.').fadeIn('fast');
        console.log('getting /get_home_timeline...');
        $.getJSON('/get_home_timeline', function(response) {
            console.log('got timeline.');
//            console.log(response);
            onTweetsLoaded(response);
        });
    }
    
    var numTweets = 0;
    var numPages = 0;
    var maxNumPages = 5; // n * 100 tweets will be shown

    function onTweetsLoaded(rsp) {
        //console.log('onTweetsLoaded: ' + rsp.length);
        if (!Fizz.active()) return;
        numPages++;
        //console.log(rsp);
        var tweets = rsp;
//        var tweets = rsp.array;
        if (tweets && tweets.length) {
            var maxId = numPages < maxNumPages && tweets.length ? tweets[tweets.length-1].idStr : null;
            addTweetFromTweets(tweets.slice(), maxId);
        }
    }

    function addTweetFromTweets(tweets, maxId) {
        //console.log('addTweetFromTweets: tweets: ' + tweets.length + ', maxId: ' + maxId);
        if (!Fizz.active()) return;
        var tweet = tweets.pop();
        //console.log(tweet);
//        console.log(tweet.user.screenName);
        if (!(tweet.user.screen_name in usersById)) {
            usersById[tweet.user.screen_name] = { id: tweet.user.screen_name, text: tweet.user.screen_name, size: 6 + Math.random() * 4, data: tweet.user };
            Fizz.addBubble(usersById[tweet.user.screen_name]);
        }
        if (!(tweet.idStr in statusesById)) {
            statusesById[tweet.id_str] = { id: tweet.id_str, text: tweet.text, time: Date.parse(tweet.created_at), size: 6 + Math.random() * 4, data: tweet };
            Fizz.addBubble(statusesById[tweet.id_str], tweet.user.screen_name);
        }
        if (tweets.length) {
            setTimeout(addTweetFromTweets, 30, tweets, maxId);
        }
        else if (maxId) {
            window.fetchTweets(maxId);
        }
    }
    
    
    function renderStuff(data) {
        if (!Fizz.active()) return;
        var entry = data.pop();
        if (!(entry.from.id in usersById)) {
            usersById[entry.from.id] = { id: entry.from.id, text: entry.from.name, size: 6 + Math.random() * 4, data: entry.from };
            Fizz.addBubble(usersById[entry.from.id]);
        }
        if (!(entry.id in statusesById)) {
            //console.log(entry);
            var t = parseFBDate(entry.created_time);
            statusesById[entry.id] = { id: entry.id, time: t, text: entry.message || entry.description || entry.caption || '', size: 6 + Math.random() * 4, data: entry };
            Fizz.addBubble(statusesById[entry.id], entry.from.id);
            if (data.length) {
                setTimeout(renderStuff, 30, data);
            }
        }
    }
    
    function onTweetsError(error) {
        console.error(error);
    }
}

function initForTwUser(user) {

    if (!Fizz.active()) {
        Fizz.active(true);
//        $('#userinfo').html('<img src="'+user.profileImageUrl+'" alt="'+user.name+'" class="user"/> <b>This is Fizz.</b> <a href="https://spreadsheets.google.com/viewform?hl=en&formkey=dGZINGpDQ3NubVNiMlY3eFZ6MUNGdFE6MQ#gid=0">We&#8217;d love to know what you think<\/a>. <br><br>You&#8217;re logged in as ' + user.name + ' on Twitter.').fadeIn('fast');
//        $('#userinfo').html('<b>This is Fizz, from Bloom</b> <a href="https://spreadsheets.google.com/viewform?hl=en&formkey=dGZINGpDQ3NubVNiMlY3eFZ6MUNGdFE6MQ#gid=0">We&#8217;d love to know what you think<\/a>.').fadeIn('fast');
        $('#userinfo').html('<b>This is Fizz, from Bloom</b> You\'re looking at tweets in Simon Murtha-Smith\'s timeline pulled from his Locker. Big circles are people, small circles are status updates.').fadeIn('fast');
        window.fetchTweets = function(max_id) {
            /*var params = {
                count: 100, 
                //rpp:3, 
                //since_id:171981, 
                //max_id:181981, 
                success: onTweetsLoaded, 
                error: onTweetsError
            };
            if (max_id) {
                params['max_id'] = max_id;
            }
            user.homeTimeline(params);  */
            $.getJSON('/get_home_timeline', function(response) {
                parseResponse(response);
            });
        }
        window.fetchTweets();
    }
  
    var numTweets = 0;
    var numPages = 0;
    var maxNumPages = 5; // n * 100 tweets will be shown
    
    function onTweetsLoaded(rsp) {
        if (!Fizz.active()) return;
        numPages++;
        var tweets = rsp.array;
        if (tweets && tweets.length) {
            var maxId = numPages < maxNumPages && tweets.length ? tweets[tweets.length-1].idStr : null;
            addTweetFromTweets(tweets.slice(), maxId);
        }
    }
    
    function addTweetFromTweets(tweets, maxId) {
        if (!Fizz.active()) return;
        var tweet = tweets.pop();
        if (!(tweet.user.screenName in usersById)) {
            usersById[tweet.user.screenName] = { id: tweet.user.screenName, text: tweet.user.screenName, size: 6 + Math.random() * 4, data: tweet.user };
            Fizz.addBubble(usersById[tweet.user.screenName]);
        }
        if (!(tweet.idStr in statusesById)) {
            statusesById[tweet.idStr] = { id: tweet.idStr, text: tweet.text, time: Date.parse(tweet.attributes.created_at), size: 6 + Math.random() * 4, data: tweet };
            Fizz.addBubble(statusesById[tweet.idStr], tweet.user.screenName);
        }
        if (tweets.length) {
            setTimeout(addTweetFromTweets, 30, tweets, maxId);
        }
        else if (maxId) {
            window.fetchTweets(maxId);
        }
    }
    function onTweetsError(error) {
        console.error(error);
    }
    
}
    </script>
</html>
